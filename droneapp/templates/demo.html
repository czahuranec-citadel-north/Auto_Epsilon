{% extends "layout.html" %}

{% block content %}
<style>
    body {
        background-color: #1a1b19;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    .demo-container {
        max-width: 1800px;
        margin: 0 auto;
        padding: 20px;
    }

    .demo-header {
        text-align: center;
        padding: 20px;
        background: linear-gradient(135deg, #2B2D2A 0%, #1a1b19 100%);
        border: 2px solid #FDB913;
        border-radius: 10px;
        margin-bottom: 20px;
        box-shadow: 0 4px 15px rgba(253, 185, 19, 0.3);
    }

    .demo-header h1 {
        color: #FDB913;
        margin: 0 0 10px 0;
        font-size: 2.5em;
        text-shadow: 0 0 10px rgba(253, 185, 19, 0.5);
    }

    .demo-header p {
        color: #ddd;
        margin: 0;
        font-size: 1.2em;
    }

    /* Control Panel at Top */
    .control-panel {
        background-color: rgba(42, 45, 42, 0.8);
        border: 2px solid rgba(253, 185, 19, 0.3);
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
    }

    .control-panel h2 {
        color: #FDB913;
        margin-top: 0;
        font-size: 1.5em;
        border-bottom: 2px solid #FDB913;
        padding-bottom: 10px;
    }

    .control-buttons {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        justify-content: center;
        margin-bottom: 15px;
    }

    .control-btn {
        padding: 8px 20px;
        font-size: 0.9em;
        font-weight: bold;
        border: 2px solid #FDB913;
        background: linear-gradient(135deg, #2B2D2A 0%, #1a1b19 100%);
        color: #FDB913;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
    }

    .control-btn:hover {
        background: linear-gradient(135deg, #FDB913 0%, #ffa500 100%);
        color: #1a1b19;
        transform: translateY(-2px);
        box-shadow: 0 4px 10px rgba(253, 185, 19, 0.5);
    }

    .control-btn.danger {
        border-color: #ff4444;
        color: #ff4444;
    }

    .control-btn.danger:hover {
        background: linear-gradient(135deg, #ff4444 0%, #cc0000 100%);
        color: white;
    }

    .status-bar {
        display: flex;
        gap: 20px;
        justify-content: space-around;
        flex-wrap: wrap;
        padding: 15px;
        background-color: rgba(253, 185, 19, 0.1);
        border-radius: 8px;
        margin-bottom: 15px;
    }

    .status-item {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 5px;
    }

    .status-label {
        color: #FDB913;
        font-size: 0.9em;
        font-weight: bold;
    }

    .status-value {
        color: #fff;
        font-size: 1.3em;
        font-weight: bold;
        font-family: 'Courier New', monospace;
    }

    /* Main Content Grid */
    .main-content-grid {
        display: grid;
        grid-template-columns: 1fr 1fr 1fr;
        gap: 20px;
        margin-bottom: 20px;
    }

    /* Chatbot Section */
    .chatbot-section {
        background-color: rgba(42, 45, 42, 0.8);
        border: 2px solid rgba(253, 185, 19, 0.3);
        border-radius: 10px;
        padding: 20px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        display: flex;
        flex-direction: column;
    }

    .chatbot-section h3 {
        color: #FDB913;
        margin-top: 0;
        font-size: 1.2em;
        border-bottom: 2px solid #FDB913;
        padding-bottom: 10px;
        margin-bottom: 15px;
    }

    .chat-messages {
        flex: 1;
        overflow-y: auto;
        background-color: #1a1b19;
        border: 1px solid rgba(253, 185, 19, 0.2);
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 15px;
        min-height: 400px;
        max-height: 600px;
    }

    .message {
        margin-bottom: 15px;
        padding: 12px 15px;
        border-radius: 8px;
        max-width: 80%;
        word-wrap: break-word;
    }

    .message.user {
        background-color: rgba(253, 185, 19, 0.2);
        border-left: 4px solid #FDB913;
        margin-left: auto;
        text-align: right;
    }

    .message.drone {
        background-color: rgba(42, 45, 42, 0.8);
        border-left: 4px solid #4CAF50;
    }

    .message-sender {
        font-weight: bold;
        margin-bottom: 5px;
        font-size: 0.9em;
    }

    .message.user .message-sender {
        color: #FDB913;
    }

    .message.drone .message-sender {
        color: #4CAF50;
    }

    .message-text {
        color: #ddd;
        line-height: 1.4;
    }

    .chat-input-container {
        display: flex;
        gap: 10px;
    }

    .chat-input {
        flex: 1;
        padding: 12px 15px;
        font-size: 1em;
        background-color: #1a1b19;
        border: 2px solid rgba(253, 185, 19, 0.3);
        border-radius: 8px;
        color: #fff;
    }

    .chat-input:focus {
        outline: none;
        border-color: #FDB913;
        box-shadow: 0 0 10px rgba(253, 185, 19, 0.3);
    }

    .chat-send-btn {
        padding: 12px 30px;
        font-size: 1em;
        font-weight: bold;
        background: linear-gradient(135deg, #FDB913 0%, #ffa500 100%);
        color: #1a1b19;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .chat-send-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 10px rgba(253, 185, 19, 0.5);
    }

    /* Visualization Panels */
    .viz-panel {
        background-color: rgba(42, 45, 42, 0.8);
        border: 2px solid rgba(253, 185, 19, 0.3);
        border-radius: 10px;
        padding: 20px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        display: flex;
        flex-direction: column;
    }

    .viz-panel h3 {
        color: #FDB913;
        margin-top: 0;
        font-size: 1.2em;
        border-bottom: 2px solid #FDB913;
        padding-bottom: 10px;
        margin-bottom: 15px;
    }

    .zoom-controls {
        display: flex;
        gap: 10px;
        align-items: center;
        margin-bottom: 10px;
        justify-content: center;
    }

    .zoom-btn {
        padding: 5px 15px;
        font-size: 0.85em;
        font-weight: bold;
        border: 1px solid #FDB913;
        background-color: rgba(42, 45, 42, 0.8);
        color: #FDB913;
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .zoom-btn:hover {
        background-color: #FDB913;
        color: #1a1b19;
    }

    .zoom-btn.active {
        background-color: #FDB913;
        color: #1a1b19;
    }

    .zoom-label {
        color: #aaa;
        font-size: 0.9em;
    }

    .map-container {
        width: 100%;
        height: 500px;
        background-color: #1a1b19;
        border: 1px solid rgba(253, 185, 19, 0.2);
        border-radius: 8px;
        position: relative;
        overflow: hidden;
        cursor: grab;
    }

    .map-container:active {
        cursor: grabbing;
    }

    .camera-container {
        width: 100%;
        height: 500px;
        background-color: #1a1b19;
        border: 1px solid rgba(253, 185, 19, 0.2);
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
        overflow: hidden;
    }

    .camera-placeholder {
        color: #666;
        font-size: 1.2em;
        text-align: center;
    }

    #camera-feed {
        max-width: 100%;
        max-height: 100%;
        object-fit: contain;
    }

    @media (max-width: 1400px) {
        .main-content-grid {
            grid-template-columns: 1fr;
        }

        .chat-messages {
            min-height: 300px;
            max-height: 400px;
        }

        .map-container, .camera-container {
            height: 400px;
        }
    }

    /* Loading indicator */
    .loading {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid rgba(253, 185, 19, 0.3);
        border-radius: 50%;
        border-top-color: #FDB913;
        animation: spin 1s ease-in-out infinite;
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }

    /* Controller Sidebar */
    .controller-sidebar {
        position: fixed;
        right: -370px;
        top: 0;
        width: 380px;
        height: 100vh;
        background: linear-gradient(135deg, #2B2D2A 0%, #1a1b19 100%);
        border-left: 3px solid #FDB913;
        box-shadow: -5px 0 20px rgba(0, 0, 0, 0.5);
        transition: right 0.3s ease;
        z-index: 999;
        overflow-y: auto;
        padding: 20px;
    }

    .controller-sidebar.open {
        right: 0;
    }

    .controller-header {
        color: #FDB913;
        font-size: 1.5em;
        margin-bottom: 20px;
        text-align: center;
        border-bottom: 2px solid #FDB913;
        padding-bottom: 10px;
    }

    .controller-section {
        margin-bottom: 30px;
    }

    .controller-section h4 {
        color: #FDB913;
        font-size: 1em;
        margin-bottom: 15px;
        text-align: center;
        text-transform: uppercase;
        letter-spacing: 1px;
    }

    .controller-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 10px;
        max-width: 300px;
        margin: 0 auto;
    }

    .controller-btn {
        aspect-ratio: 1;
        background: linear-gradient(135deg, #2B2D2A 0%, #1a1b19 100%);
        border: 2px solid #FDB913;
        border-radius: 8px;
        color: #FDB913;
        font-size: 0.9em;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 5px;
        user-select: none;
    }

    .controller-btn:active {
        background: linear-gradient(135deg, #FDB913 0%, #ffa500 100%);
        color: #1a1b19;
        transform: scale(0.95);
    }

    .controller-btn:hover {
        border-color: #ffa500;
        box-shadow: 0 0 15px rgba(253, 185, 19, 0.5);
    }

    .controller-btn.center {
        background: linear-gradient(135deg, #ff4444 0%, #cc0000 100%);
        border-color: #ff4444;
        color: white;
    }

    .controller-btn.center:hover {
        border-color: #ff6666;
        box-shadow: 0 0 15px rgba(255, 68, 68, 0.5);
    }

    .controller-btn-icon {
        font-size: 1.5em;
    }

    .controller-btn-label {
        font-size: 0.7em;
    }

    .controller-info {
        background: rgba(253, 185, 19, 0.1);
        border: 1px solid rgba(253, 185, 19, 0.3);
        border-radius: 8px;
        padding: 15px;
        color: #ddd;
        font-size: 0.85em;
        line-height: 1.6;
        margin-top: 20px;
    }

    .controller-info strong {
        color: #FDB913;
    }
</style>

<div class="demo-container">
    <!-- Header -->
    <div class="demo-header">
        <h1>Auto Epsilon - Disaster Response Drone</h1>
        <p>AI-Powered Search & Rescue with Medical Triage</p>
    </div>

    <!-- Control Panel -->
    <div class="control-panel">
        <h2>Drone Controls</h2>

        <!-- Status Bar -->
        <div class="status-bar">
            <div class="status-item">
                <span class="status-label">STATUS</span>
                <span class="status-value" id="status-mode">IDLE</span>
            </div>
            <div class="status-item">
                <span class="status-label">ALTITUDE</span>
                <span class="status-value" id="status-altitude">0.0m</span>
            </div>
            <div class="status-item">
                <span class="status-label">POSITION</span>
                <span class="status-value" id="status-position">0.0, 0.0</span>
            </div>
            <div class="status-item">
                <span class="status-label">BATTERY</span>
                <span class="status-value" id="status-battery">100%</span>
            </div>
        </div>

        <!-- Control Buttons -->
        <div class="control-buttons">
            <button class="control-btn" id="btn-arm" onclick="armDrone()">ARM</button>
            <button class="control-btn" id="btn-takeoff" onclick="takeoffDrone()">TAKEOFF</button>
            <button class="control-btn" id="btn-land" onclick="landDrone()">LAND</button>
            <button class="control-btn" id="btn-waypoint-test" onclick="runWaypointTest()" style="background: linear-gradient(135deg, #4CAF50 0%, #2e7d32 100%); border-color: #4CAF50; color: white;">RUN WAYPOINT TEST</button>
            <button class="control-btn danger" id="btn-emergency" onclick="emergencyStop()">EMERGENCY STOP</button>
        </div>
    </div>

    <!-- Main Content Grid: Chatbot | Map | Camera -->
    <div class="main-content-grid">
        <!-- Chatbot Section -->
        <div class="chatbot-section">
            <h3>Natural Language Control</h3>
            <div class="chat-messages" id="chat-messages">
                <div class="message drone">
                    <div class="message-sender">Drone:</div>
                    <div class="message-text">Ready for mission. What are your orders?</div>
                </div>
            </div>
            <div class="chat-input-container">
                <input type="text"
                       class="chat-input"
                       id="chat-input"
                       placeholder="Type your command..."
                       onkeypress="if(event.key === 'Enter') sendMessage()">
                <button class="chat-send-btn" onclick="sendMessage()">Send</button>
            </div>
        </div>

        <!-- Map Panel -->
        <div class="viz-panel">
            <h3>Warehouse Map</h3>
            <div class="zoom-controls">
                <span class="zoom-label">View Range:</span>
                <button class="zoom-btn" onclick="setMapZoom(10)">10m</button>
                <button class="zoom-btn active" onclick="setMapZoom(20)">20m</button>
                <button class="zoom-btn" onclick="setMapZoom(40)">40m</button>
                <button class="zoom-btn" onclick="setMapZoom(60)">60m</button>
                <span class="zoom-label">(or use mouse wheel)</span>
            </div>
            <div class="map-container" id="map-container">
                <canvas id="map-canvas"></canvas>
            </div>
        </div>

        <!-- Camera Panel -->
        <div class="viz-panel">
            <h3>Camera Feed</h3>
            <div class="camera-container">
                <div class="camera-placeholder" id="camera-placeholder">
                    Camera feed will appear here...
                </div>
                <img id="camera-feed" style="display: none;">
            </div>
        </div>
    </div>

    <!-- Controller Sidebar -->
    <div class="controller-sidebar" id="controller-sidebar">
        <h3 class="controller-header">Manual Control</h3>

        <!-- Throttle Section -->
        <div class="controller-section">
            <h4>Throttle (Altitude)</h4>
            <div class="controller-grid">
                <div></div>
                <button class="controller-btn" onmousedown="sendCommand('up')" onmouseup="sendCommand('stop')">
                    <span class="controller-btn-icon">▲</span>
                    <span class="controller-btn-label">UP</span>
                </button>
                <div></div>
                <div></div>
                <div></div>
                <div></div>
                <div></div>
                <button class="controller-btn" onmousedown="sendCommand('down')" onmouseup="sendCommand('stop')">
                    <span class="controller-btn-icon">▼</span>
                    <span class="controller-btn-label">DOWN</span>
                </button>
                <div></div>
            </div>
        </div>

        <!-- Pitch & Roll Section -->
        <div class="controller-section">
            <h4>Pitch & Roll (Movement)</h4>
            <div class="controller-grid">
                <div></div>
                <button class="controller-btn" onmousedown="sendCommand('forward')" onmouseup="sendCommand('stop')">
                    <span class="controller-btn-icon">↑</span>
                    <span class="controller-btn-label">FORWARD</span>
                </button>
                <div></div>
                <button class="controller-btn" onmousedown="sendCommand('left')" onmouseup="sendCommand('stop')">
                    <span class="controller-btn-icon">←</span>
                    <span class="controller-btn-label">LEFT</span>
                </button>
                <button class="controller-btn center" onclick="sendCommand('stop')">
                    <span class="controller-btn-icon">■</span>
                    <span class="controller-btn-label">STOP</span>
                </button>
                <button class="controller-btn" onmousedown="sendCommand('right')" onmouseup="sendCommand('stop')">
                    <span class="controller-btn-icon">→</span>
                    <span class="controller-btn-label">RIGHT</span>
                </button>
                <div></div>
                <button class="controller-btn" onmousedown="sendCommand('back')" onmouseup="sendCommand('stop')">
                    <span class="controller-btn-icon">↓</span>
                    <span class="controller-btn-label">BACK</span>
                </button>
                <div></div>
            </div>
        </div>

        <!-- Yaw Section -->
        <div class="controller-section">
            <h4>Yaw (Rotation)</h4>
            <div class="controller-grid">
                <button class="controller-btn" onmousedown="sendCommand('counterclockwise')" onmouseup="sendCommand('stop')">
                    <span class="controller-btn-icon">↺</span>
                    <span class="controller-btn-label">CCW</span>
                </button>
                <div></div>
                <button class="controller-btn" onmousedown="sendCommand('clockwise')" onmouseup="sendCommand('stop')">
                    <span class="controller-btn-icon">↻</span>
                    <span class="controller-btn-label">CW</span>
                </button>
            </div>
        </div>

        <!-- Info Section -->
        <div class="controller-info">
            <strong>Instructions:</strong><br>
            • Press and hold buttons to move<br>
            • Release to stop automatically<br>
            • Use STOP button for immediate halt<br>
            • Each press moves 0.5m<br>
            • Requires offboard mode (auto-enabled)
        </div>
    </div>
</div>

<script>
    // Global state
    let droneState = {
        position: { north: 0, east: 0, altitude: 0 },
        target: null,
        path: [],
        mode: 'IDLE',
        battery: 100
    };

    // Map zoom state (view range in meters from center)
    let mapViewRange = 20;  // Default 20m range (40m total view)

    // Set map zoom level
    function setMapZoom(range) {
        mapViewRange = range;

        // Update active button
        document.querySelectorAll('.zoom-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        event.target.classList.add('active');

        // Redraw map
        drawMap();
    }

    // Initialize map
    function initMap() {
        const canvas = document.getElementById('map-canvas');
        const container = document.getElementById('map-container');
        canvas.width = canvas.offsetWidth;
        canvas.height = canvas.offsetHeight;

        // Add mouse wheel zoom
        container.addEventListener('wheel', (e) => {
            e.preventDefault();

            // Zoom in/out with wheel
            if (e.deltaY < 0) {
                // Zoom in (decrease view range)
                mapViewRange = Math.max(5, mapViewRange - 2);
            } else {
                // Zoom out (increase view range)
                mapViewRange = Math.min(100, mapViewRange + 2);
            }

            // Update button states
            document.querySelectorAll('.zoom-btn').forEach(btn => {
                btn.classList.remove('active');
            });

            drawMap();
        });

        drawMap();
    }

    // Draw warehouse map with drone position
    function drawMap() {
        const canvas = document.getElementById('map-canvas');
        if (!canvas) {
            console.error('Canvas not found!');
            return;
        }
        const ctx = canvas.getContext('2d');
        const width = canvas.width;
        const height = canvas.height;

        // Debug log
        if (Math.random() < 0.1) { // Log 10% of the time to avoid spam
            console.log('Drawing map:', {
                canvasSize: `${width}x${height}`,
                dronePos: `N=${droneState.position.north.toFixed(2)}, E=${droneState.position.east.toFixed(2)}`
            });
        }

        // Clear canvas
        ctx.fillStyle = '#1a1b19';
        ctx.fillRect(0, 0, width, height);

        // Draw grid
        ctx.strokeStyle = 'rgba(253, 185, 19, 0.1)';
        ctx.lineWidth = 1;
        const gridSize = 50;
        for (let x = 0; x < width; x += gridSize) {
            ctx.beginPath();
            ctx.moveTo(x, 0);
            ctx.lineTo(x, height);
            ctx.stroke();
        }
        for (let y = 0; y < height; y += gridSize) {
            ctx.beginPath();
            ctx.moveTo(0, y);
            ctx.lineTo(width, y);
            ctx.stroke();
        }

        // Dynamic scale based on zoom level (view range)
        // Calculate pixels per meter so that mapViewRange fits from center to edge
        const scale = Math.min(width, height) / (2 * mapViewRange);
        const centerX = width / 2;
        const centerY = height / 2;

        // Helper function to convert world coordinates to canvas coordinates
        function worldToCanvas(worldX, worldY) {
            return {
                x: centerX + (worldX * scale),
                y: centerY - (worldY * scale)  // Invert Y axis (North is up)
            };
        }

        // Helper function to draw a box from center position and size
        function drawBox(worldX, worldY, sizeX, sizeY, color, filled = true) {
            const pos = worldToCanvas(worldX, worldY);
            const w = sizeX * scale;
            const h = sizeY * scale;
            ctx.fillStyle = color;
            ctx.strokeStyle = color;
            if (filled) {
                ctx.fillRect(pos.x - w/2, pos.y - h/2, w, h);
            } else {
                ctx.strokeRect(pos.x - w/2, pos.y - h/2, w, h);
            }
        }

        // Draw warehouse outer walls (30m x 30m building)
        // Walls are 0.5m thick, 6m tall (shown in 2D from above)
        ctx.fillStyle = 'rgba(100, 100, 100, 0.8)';

        // North wall: position (0, 15), size 30m x 0.5m
        drawBox(0, 15, 30, 0.5, 'rgba(100, 100, 100, 0.8)');

        // South wall: position (0, -15), size 30m x 0.5m
        drawBox(0, -15, 30, 0.5, 'rgba(100, 100, 100, 0.8)');

        // East wall: position (15, 0), size 0.5m x 30m
        drawBox(15, 0, 0.5, 30, 'rgba(100, 100, 100, 0.8)');

        // West wall: position (-15, 0), size 0.5m x 30m
        drawBox(-15, 0, 0.5, 30, 'rgba(100, 100, 100, 0.8)');

        // Draw interior dividing walls (creates rooms)
        ctx.fillStyle = 'rgba(120, 120, 120, 0.7)';

        // Divider East: position (7.5, -7), size 14m x 0.3m (creates SE room)
        drawBox(7.5, -7, 14, 0.3, 'rgba(120, 120, 120, 0.7)');

        // Divider West: position (-7.5, 7), size 14m x 0.3m (creates NW room)
        drawBox(-7.5, 7, 14, 0.3, 'rgba(120, 120, 120, 0.7)');

        // Draw storage boxes/obstacles
        // Box1: position (10, 10), size 2m x 2m
        drawBox(10, 10, 2, 2, 'rgba(200, 150, 100, 0.8)');

        // Box2: position (-10, -10), size 2m x 2m
        drawBox(-10, -10, 2, 2, 'rgba(200, 150, 100, 0.8)');

        // Box3: position (10, -10), size 1.5m x 1.5m
        drawBox(10, -10, 1.5, 1.5, 'rgba(180, 130, 80, 0.8)');

        // Box4: position (-10, 10), size 1.8m x 1.8m
        drawBox(-10, 10, 1.8, 1.8, 'rgba(190, 140, 90, 0.8)');

        // Draw center origin (spawn point)
        ctx.fillStyle = 'rgba(253, 185, 19, 0.5)';
        ctx.beginPath();
        ctx.arc(centerX, centerY, 5, 0, 2 * Math.PI);
        ctx.fill();

        // Draw path history
        if (droneState.path.length > 1) {
            ctx.strokeStyle = 'rgba(76, 175, 80, 0.5)';
            ctx.lineWidth = 2;
            ctx.beginPath();
            for (let i = 0; i < droneState.path.length; i++) {
                const pos = droneState.path[i];
                const pathPos = worldToCanvas(pos.east, pos.north);
                if (i === 0) {
                    ctx.moveTo(pathPos.x, pathPos.y);
                } else {
                    ctx.lineTo(pathPos.x, pathPos.y);
                }
            }
            ctx.stroke();
        }

        // Draw drone position using consistent scale
        const dronePos = worldToCanvas(droneState.position.east, droneState.position.north);
        const droneX = dronePos.x;
        const droneY = dronePos.y;

        // Drone body
        ctx.fillStyle = '#FDB913';
        ctx.beginPath();
        ctx.arc(droneX, droneY, 10, 0, 2 * Math.PI);
        ctx.fill();

        // Drone direction indicator
        ctx.strokeStyle = '#FDB913';
        ctx.lineWidth = 3;
        ctx.beginPath();
        ctx.moveTo(droneX, droneY);
        ctx.lineTo(droneX, droneY - 20);
        ctx.stroke();

        // Draw target if exists
        if (droneState.target) {
            const targetPos = worldToCanvas(droneState.target.east, droneState.target.north);
            ctx.strokeStyle = '#ff4444';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.arc(targetPos.x, targetPos.y, 8, 0, 2 * Math.PI);
            ctx.stroke();
        }

        // Draw position text and zoom level
        ctx.fillStyle = '#FDB913';
        ctx.font = '12px monospace';
        ctx.fillText(`Position: (${droneState.position.north.toFixed(1)}m N, ${droneState.position.east.toFixed(1)}m E)`, 10, height - 10);
        ctx.fillStyle = '#888';
        ctx.fillText(`View: ${(mapViewRange * 2).toFixed(0)}m range`, width - 120, height - 10);
    }

    // Update telemetry
    function updateTelemetry() {
        fetch('/api/telemetry/')
            .then(response => response.json())
            .then(data => {
                // Update drone state with real MAVSDK data
                droneState.position.north = data.position.north;
                droneState.position.east = data.position.east;
                droneState.position.altitude = data.position.altitude;
                droneState.mode = data.flight_mode || droneState.mode;
                droneState.battery = data.battery || 100;

                // Debug logging
                console.log('Position update:', {
                    north: data.position.north.toFixed(2),
                    east: data.position.east.toFixed(2),
                    alt: data.position.altitude.toFixed(2)
                });

                // Update status bar
                document.getElementById('status-mode').textContent = droneState.mode;
                document.getElementById('status-altitude').textContent = data.position.altitude.toFixed(1) + 'm';
                document.getElementById('status-position').textContent =
                    `${data.position.north.toFixed(1)}, ${data.position.east.toFixed(1)}`;
                document.getElementById('status-battery').textContent = droneState.battery.toFixed(0) + '%';

                // Add to path if position changed significantly
                const lastPos = droneState.path[droneState.path.length - 1];
                if (!lastPos ||
                    Math.abs(lastPos.north - droneState.position.north) > 0.3 ||
                    Math.abs(lastPos.east - droneState.position.east) > 0.3) {
                    droneState.path.push({
                        north: droneState.position.north,
                        east: droneState.position.east,
                        altitude: droneState.position.altitude
                    });
                    console.log('Path updated, length:', droneState.path.length);
                }

                drawMap();
            })
            .catch(err => console.error('Telemetry error:', err));
    }

    // Control functions
    function armDrone() {
        addChatMessage('user', 'Arm the drone');
        fetch('/api/command/', {
            method: 'POST',
            headers: {'Content-Type': 'application/x-www-form-urlencoded'},
            body: 'command=arm'
        })
        .then(response => response.json())
        .then(data => {
            addChatMessage('drone', 'Armed and ready for takeoff');
        })
        .catch(err => {
            addChatMessage('drone', 'Error: Could not arm drone');
            console.error(err);
        });
    }

    function takeoffDrone() {
        addChatMessage('user', 'Take off to 2 meters');
        fetch('/api/command/', {
            method: 'POST',
            headers: {'Content-Type': 'application/x-www-form-urlencoded'},
            body: 'command=takeoff'
        })
        .then(response => response.json())
        .then(data => {
            addChatMessage('drone', 'Roger. Taking off to 2 meters...');
        })
        .catch(err => {
            addChatMessage('drone', 'Error: Takeoff failed');
            console.error(err);
        });
    }

    function landDrone() {
        addChatMessage('user', 'Land the drone');
        fetch('/api/command/', {
            method: 'POST',
            headers: {'Content-Type': 'application/x-www-form-urlencoded'},
            body: 'command=land'
        })
        .then(response => response.json())
        .then(data => {
            addChatMessage('drone', 'Landing...');
        })
        .catch(err => {
            addChatMessage('drone', 'Error: Landing failed');
            console.error(err);
        });
    }

    function emergencyStop() {
        if (confirm('Are you sure? This will immediately cut motors!')) {
            addChatMessage('user', 'EMERGENCY STOP');
            fetch('/api/command/', {
                method: 'POST',
                headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                body: 'command=emergency_stop'
            })
            .then(response => response.json())
            .then(data => {
                addChatMessage('drone', 'EMERGENCY STOP ACTIVATED');
            })
            .catch(err => console.error(err));
        }
    }

    function runWaypointTest() {
        addChatMessage('user', 'Run waypoint navigation test (3m square pattern)');
        addChatMessage('drone', 'Starting waypoint test... Watch the Gazebo window!');

        fetch('/api/run_waypoint_test/', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'}
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                addChatMessage('drone', 'Waypoint test running. Check terminal logs for detailed progress.');
            } else {
                addChatMessage('drone', 'Error: ' + (data.message || 'Could not start waypoint test'));
            }
        })
        .catch(err => {
            addChatMessage('drone', 'Error: Failed to start waypoint test');
            console.error(err);
        });
    }

    // Chat functions
    function sendMessage() {
        const input = document.getElementById('chat-input');
        const message = input.value.trim();
        if (!message) return;

        addChatMessage('user', message);
        input.value = '';

        // Send to backend for AI processing
        fetch('/api/chat/', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({message: message})
        })
        .then(response => response.json())
        .then(data => {
            addChatMessage('drone', data.response);
        })
        .catch(err => {
            addChatMessage('drone', 'Processing command...');
            console.error(err);
        });
    }

    function addChatMessage(sender, text) {
        const messagesDiv = document.getElementById('chat-messages');
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${sender}`;
        messageDiv.innerHTML = `
            <div class="message-sender">${sender === 'user' ? 'You' : 'Drone'}:</div>
            <div class="message-text">${text}</div>
        `;
        messagesDiv.appendChild(messageDiv);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    // Update camera feed
    function updateCamera() {
        fetch('/api/camera/stream')
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success' && data.frame) {
                    const img = document.getElementById('camera-feed');
                    const placeholder = document.getElementById('camera-placeholder');
                    img.src = 'data:image/jpeg;base64,' + data.frame;
                    img.style.display = 'block';
                    placeholder.style.display = 'none';
                }
            })
            .catch(err => console.error('Camera error:', err));
    }

    // Controller sidebar functions - now hover-based
    function openController() {
        const sidebar = document.getElementById('controller-sidebar');
        sidebar.classList.add('open');
    }

    function closeController() {
        const sidebar = document.getElementById('controller-sidebar');
        sidebar.classList.remove('open');
    }

    function sendCommand(cmd) {
        fetch('/api/command/', {
            method: 'POST',
            headers: {'Content-Type': 'application/x-www-form-urlencoded'},
            body: `command=${cmd}`
        })
        .then(response => response.json())
        .then(data => {
            console.log(`Command ${cmd}: ${data.status}`);
        })
        .catch(err => console.error('Command error:', err));
    }

    // Initialize on load
    window.addEventListener('load', function() {
        initMap();
        updateTelemetry();
        updateCamera();

        setInterval(updateTelemetry, 500); // Update every 500ms
        setInterval(updateCamera, 200);     // Update camera at 5 FPS

        // Resize map on window resize
        window.addEventListener('resize', function() {
            initMap();
        });

        // Setup hover-based controller sidebar
        const sidebar = document.getElementById('controller-sidebar');

        sidebar.addEventListener('mouseenter', openController);
        sidebar.addEventListener('mouseleave', closeController);
    });
</script>

{% endblock %}
