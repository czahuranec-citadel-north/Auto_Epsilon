{% extends "layout.html" %}

{% block content %}
<!-- Three.js Library -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>

<!-- ROS Libraries -->
<script src="https://cdn.jsdelivr.net/npm/eventemitter2@6.4.9/lib/eventemitter2.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/roslib@1.3.0/build/roslib.min.js"></script>

<style>
    .controller-box {
        text-align: center;
    }

    .control-table {
        margin: 0 auto;
        border-spacing: 15px;
    }

    .control-section {
        background-color: rgba(42, 45, 42, 0.4);
        border: 1px solid rgba(253, 185, 19, 0.2);
        border-radius: 8px;
        padding: 15px;
    }

    #streamingdroneimage, .drone-feed {
        max-width: 100%;
        height: auto;
    }

    /* Visualization styles */
    .viz-container {
        display: flex;
        justify-content: space-around;
        align-items: flex-start;
        gap: 20px;
        margin: 20px auto;
        max-width: 1600px;
        flex-wrap: wrap;
    }

    .viz-panel {
        background-color: rgba(42, 45, 42, 0.6);
        border: 2px solid rgba(253, 185, 19, 0.3);
        border-radius: 8px;
        padding: 15px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        flex: 1;
        min-width: 400px;
    }

    .viz-panel h3 {
        margin-top: 0;
        color: #FDB913;
        text-align: center;
        border-bottom: 2px solid #FDB913;
        padding-bottom: 10px;
    }

    #drone-viz-container {
        width: 100%;
        height: 500px;
        background-color: #2B2D2A;
        border-radius: 4px;
        position: relative;
    }

    .video-container {
        width: 100%;
        height: 500px;
        display: flex;
        align-items: center;
        justify-content: center;
        background-color: #1a1b19;
        border-radius: 4px;
    }

    #laser-scan-container {
        width: 100%;
        height: 500px;
        background-color: #2B2D2A;
        border-radius: 4px;
        position: relative;
    }

    .video-container img {
        max-width: 100%;
        max-height: 100%;
        border-radius: 4px;
    }

    @media (max-width: 1200px) {
        .viz-container {
            flex-direction: column;
        }

        .viz-panel {
            width: 100%;
            min-width: unset;
        }
    }
</style>

<script>

    let previousCommand = ""

    function sendCommand(command, params={}) {
        console.log({action: 'sendCommand', command: command, params: params});
        params['command'] = command;
        $.post("/api/command/", params).done(function (json) {
            console.log({action: 'sendCommand', json: json});
        }, 'json')
        previousCommand = command
    }

    function getDetails() {
        //console.log({action: 'getDetails'});
        $.get("/api/details/").done(function (json) {
            $('#details').html("Here are some details: " + json)
        }, 'json')
    }

    function snapShot(){
        $.post("/api/command/", {'command': 'snapshot'}).done(function (json) {
            $('#div-snapshot').show();
            $('#snapshot').attr('src', $('#snapshot').attr('src') + '?' + Math.random());
        }, 'json')

    }

    $(document).on('pageinit', function() {
        $('#slider-speed').on("slidestop", function (event) {
            let params = {
                speed: $("#slider-speed").val(),
            };
            sendCommand('speed', params);
        });
    });

    function sleep(ms) {
      return new Promise(resolve => setTimeout(resolve, ms));
    }

    $(document).ready(function() {
        window.addEventListener("gamepadconnected", (event) => {
          console.log("A gamepad connected:");
          let gp = event.gamepad;
          console.log(gp);
          $('#gamepad').html(
            "Gamepad connected at index " + gp.index + ": " + gp.id +
            ". It has " + gp.buttons.length + " buttons and " + gp.axes.length + " axes."
          );
          gameLoop();
        });

        window.addEventListener("gamepaddisconnected", (event) => {
          console.log("A gamepad disconnected:");
          console.log(event.gamepad);
          $('#gamepad').text("A gamepad disconnected: " + event.gamepad);
        });

        async function gameLoop() {

          while(true) {
            let gp = navigator.getGamepads()[0];
            console.log(gp);

            $('#gamepad').html(
              "Gamepad " + gp.index + ": " + gp.id +". <br/>Buttons: <br/>"
            );

            let gamepad = $('.gamepad')

            jQuery(gp.buttons).each(function( index, button ) {
              let message = "Button" + index + ": " + button.value + " pressed: " + button.pressed + "<br/>"
              gamepad.append(message);
            })

            if (gp == null) {
              break;
            }

            let yaw = (Math.abs(gp.axes[0]) > 0.1) ? (Math.round(gp.axes[0] * 100) / 100)  : 0
            gamepad.append("Yaw - Axis0: " + yaw + "<br/>");

            let throttle = (Math.abs(gp.axes[1]) > 0.1) ? (Math.round(gp.axes[1] * 100) / 100)  : 0
            gamepad.append("Throttle - Axis1: " + throttle + "<br/>");

            let roll = (Math.abs(gp.axes[2]) > 0.1) ? (Math.round(gp.axes[2] * 100) / 100)  : 0
            gamepad.append("Roll - Axis2:" + roll + "<br/>");

            let pitch = (Math.abs(gp.axes[3]) > 0.1) ? (Math.round(gp.axes[3] * 100) / 100)  : 0
            gamepad.append("Pitch - Axis3: " + pitch + "<br/>");

            let brake = Math.round(gp.buttons[7].value *100) / 100
            gamepad.append("Brake - B7: " + brake + "<br/>");

            if (yaw != 0 || throttle != 0 || roll != 0 || pitch != 0 || brake != 0) {

              let center = 1500;
              let coef = 250
              //(1-brake); //original 250


              yaw = center + (coef*yaw);
              throttle = center + (coef*throttle);
              roll = center + (coef*roll);
              pitch = center + (coef*pitch);

              let params = {
                  yaw: yaw,
                  throttle: throttle,
                  roll: roll,
                  pitch: pitch,
                  brake: brake
              };
              sendCommand('attitude', params);
            }

            if(gp.buttons[12].value > 0 || gp.buttons[12].pressed == true) {
              sendCommand('serv_up');
            } else if(gp.buttons[13].value > 0 || gp.buttons[13].pressed == true) {
              sendCommand('serv_down');
            } else if(gp.buttons[14].value > 0 || gp.buttons[14].pressed == true) {
              sendCommand('left');
            } else if(gp.buttons[15].value > 0 || gp.buttons[15].pressed == true) {
              sendCommand('right');
            } else if(gp.buttons[10].value > 0 || gp.buttons[10].pressed == true) {
              sendCommand('takeOff');
            } else if(gp.buttons[11].value > 0 || gp.buttons[11].pressed == true) {
              sendCommand('land');
            } else if(gp.buttons[3].value > 0 || gp.buttons[3].pressed == true) {
              sendCommand('up');
            } else if(gp.buttons[0].value > 0 || gp.buttons[0].pressed == true) {
              sendCommand('down');
            }

            await sleep(100);
//            else if(gp.buttons[1].value > 0 || gp.buttons[1].pressed == true) {
//              sendCommand('clockwise');
//            } else if(gp.buttons[2].value > 0 || gp.buttons[2].pressed == true) {
//              sendCommand('counterClockwise');
//            }
          }

          //if(gp.buttons[0].value > 0 || gp.buttons[0].pressed == true) {
          //  b--;
          //} else if(gp.buttons[1].value > 0 || gp.buttons[1].pressed == true) {
          //  a++;
          //} else if(gp.buttons[2].value > 0 || gp.buttons[2].pressed == true) {
          //  b++;
          //} else if(gp.buttons[3].value > 0 || gp.buttons[3].pressed == true) {
          //  a--;
          //}

          //ball.style.left = a*2 + "px";
          //ball.style.top = b*2 + "px";

          //let start = rAF(gameLoop);
        };

        //https://keycode.info/
        $(document).keydown(function(e) {
            var key = (e.keyCode ? e.keyCode : e.charCode);
//            alert(key)
            switch (key) {
                case 87: //w
                    sendCommand('forward');
                    break;
                case 83: //s
                    sendCommand('back');
                    break;
                case 65: //a
                    sendCommand('left');
                    break;
                case 68: //d
                    sendCommand('right');
                    break;
                case 38: //up arrow
                    sendCommand('up');
                    break;
                case 40: //down arrow
                    sendCommand('down');
                    break;
                case 69: //e
                    sendCommand('clockwise');
                    break;
                case 81: //q
                    sendCommand('counterclockwise');
                    break;
                case 17: //ctrl
                    sendCommand('takeOff');
                    break;
                case 27: //escape key
                    sendCommand('land');
                    break;
                case 79: // o
                    sendCommand('stop');
                    break;
                case 104: // 8
                    sendCommand('toggle_avoid');
                    break;
                case 103: // 7
                    sendCommand('activate');
                    break;
                case 105: // 9
                    sendCommand('avoid');
                    break;
                default: break;
            }
        });

        setInterval(function() {
            getDetails()
        }, 50000);

    });



</script>

<div class="controller-box">
    <h1>Remote Controller</h1>
</div>

<div class="controller-box">
    <div data-role="controlgroup" data-type="horizontal">
        <a href="#" data-role="button" onclick="sendCommand('takeOff'); return false;">Take Off</a>
        <a href="#" data-role="button" onclick="sendCommand('land'); return false;">Land</a>
    </div>
</div>


<div style="display: flex; justify-content: center;">
    <table class="control-table">
        <tr>
        <td class="control-section">
            <h4 style="margin-top: 0; color: #FDB913;">Altitude & Rotation</h4>
            <div style="text-align: center;">
                <div class="ui-nodisc-icon ui-alt-icon">
                    <a id="up" href="#"
                       class="ui-btn ui-shadow ui-corner-all ui-icon-carat-u
                              ui-btn-icon-notext ui-btn-inline"
                       onclick="sendCommand('up'); return false;"></a>
                </div>
                <div class="ui-nodisc-icon ui-alt-icon">
                    <a href="#" class="ui-btn ui-shadow ui-corner-all ui-icon-forward
                                      ui-btn-icon-notext ui-btn-inline"
                       onclick="sendCommand('clockwise'); return false;"></a>
                    <a href="#" class="ui-btn ui-shadow ui-corner-all ui-icon-back
                                      ui-btn-icon-notext ui-btn-inline"
                       onclick="sendCommand('counterClockwise'); return false;"></a>
                </div>
                <div class="ui-nodisc-icon ui-alt-icon">
                    <a href="#" class="ui-btn ui-shadow ui-corner-all ui-icon-carat-d
                                       ui-btn-icon-notext ui-btn-inline"
                       onclick="sendCommand('down'); return false;"></a>
                </div>
            </div>
        </td>

        <td class="control-section">
            <h4 style="margin-top: 0; color: #FDB913;">Direction</h4>
            <div style="text-align: center;">
                <div class="ui-nodisc-icon ui-alt-icon">
                    <a href="#"
                       class="ui-btn ui-shadow ui-corner-all ui-icon-arrow-u
                                       ui-btn-icon-notext ui-btn-inline"
                       onclick="sendCommand('forward'); return false;"></a>
                </div>
                <div class="ui-nodisc-icon ui-alt-icon">
                    <a href="#"
                       class="ui-btn ui-shadow ui-corner-all ui-icon-arrow-l
                             ui-btn-icon-notext ui-btn-inline"
                       onclick="sendCommand('left'); return false;"></a>
                    <a href="#"
                       class="ui-btn ui-shadow ui-corner-all ui-icon-arrow-r
                             ui-btn-icon-notext ui-btn-inline"
                       onclick="sendCommand('right'); return false;"></a>
                </div>
                <div class="ui-nodisc-icon ui-alt-icon">
                    <a href="#"
                       class="ui-btn ui-shadow ui-corner-all ui-icon-arrow-d
                              ui-btn-icon-notext ui-btn-inline"
                       onclick="sendCommand('back'); return false;"></a>
                </div>
            </div>
        </td>
        </tr>
    </table>
</div>

<div class="details-box">
    <h3>Details</h3>
    <div id="details" class="details"></div>
    <!--
    * Attitude Params: What value is the Drone currently using - pitch,roll,yaw,throttle = attitude[1],attitude[2],attitude[4],attitude[3]
    * Brake Param: Percentage 0-100%
    * Distance on the axes (which direction and how far)
    * Distance from the floor (self.vehicle.rangefinder.distance) and ceiling (don't have this data yet)
    * Clean this ish up (ros2, code that compiles on any machine, remove redundant or confusing code)
    * Camera Feed - overlay collision detection
    * RVIZ (LIDAR representation) - Should we build an HTML version or should utilize RVIZ directly
    -->
</div>

<div class="controller-box">
    <h2>Gamepad</h2>
    <div id="gamepad" class="gamepad"></div>
</div>

<!-- Visualization Section: 3D View + Camera Feed -->
<div class="viz-container">
    <div class="viz-panel">
        <h3>3D Visualization</h3>
        <div id="drone-viz-container"></div>
    </div>

    <div class="viz-panel">
        <h3>Drone Camera View</h3>
        <div id="camera-container" style="width: 100%; height: 500px;"></div>
    </div>
</div>

<!-- ROS Laser Scan Visualization -->
<div class="viz-container">
    <div class="viz-panel" style="flex: 1; max-width: 100%;">
        <h3>Laser Scan Visualization (ROS Topic: /world)</h3>
        <div id="laser-scan-container"></div>
        <div style="margin-top: 10px; padding: 10px; background-color: rgba(253, 185, 19, 0.1); border-radius: 4px; font-size: 12px;">
            <strong>Legend:</strong> Red = Close obstacles | Yellow = Far obstacles | White = Robot | Gold = Forward direction
        </div>
    </div>
</div>

<div class="controller-box">
    <h3>Speed</h3>
        <input type="range" name="slider-2" id="slider-speed" data-highlight="true" min="0" max="100" value="10">
</div>

<!-- Configuration for ROS connection -->
<!-- UPDATED FILE MARKER 2025-10-09 -->
<script>
    // Configure rosbridge WebSocket URL
    // Connected to ROS VM at 192.168.56.101
    // Port 9090 is started by the Gazebo launch file
    window.ROSBRIDGE_URL = 'ws://192.168.56.101:9090';
    console.log('FILE LOADED - TIMESTAMP: 2025-10-09-16:52');
</script>

<!-- Load 3D Visualization -->
<script src="/static/js/drone-viz.js"></script>

<!-- Load Laser Scan Visualization -->
<script src="/static/js/laser-scan-viz.js"></script>

<!-- Load Camera Visualization -->
<script src="/static/js/camera-viz.js"></script>

{% endblock %}
